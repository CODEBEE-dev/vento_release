var Oe=Object.create;var C=Object.defineProperty;var Ee=Object.getOwnPropertyDescriptor;var Fe=Object.getOwnPropertyNames;var Re=Object.getPrototypeOf,Ae=Object.prototype.hasOwnProperty;var ae=(t,e)=>{for(var n in e)C(t,n,{get:e[n],enumerable:!0})},Z=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Fe(e))!Ae.call(t,s)&&s!==n&&C(t,s,{get:()=>e[s],enumerable:!(r=Ee(e,s))||r.enumerable});return t},u=(t,e,n)=>(Z(t,e,"default"),n&&Z(n,e,"default")),T=(t,e,n)=>(n=t!=null?Oe(Re(t)):{},Z(e||!t||!t.__esModule?C(n,"default",{value:t,enumerable:!0}):n,t)),Ne=t=>Z(C({},"__esModule",{value:!0}),t);var m={};ae(m,{API:()=>E,AUTOAPI_OPERATION_MAP:()=>xe,Action:()=>Q,ActionGroup:()=>ee,AutoModel:()=>k,BaseEventSchema:()=>Pe,BaseSchema:()=>D,CmdRegisterSchema:()=>st,EventModel:()=>re,EventSchema:()=>De,GROUP_PERMISSIONS:()=>$e,LoginSchema:()=>tt,PERMISSION_OPERATIONS:()=>Ke,PERMISSION_RESOURCES:()=>F,ProtoCollection:()=>G,ProtoMemDB:()=>ot,ProtoModel:()=>_,ProtoSchema:()=>A,Protofy:()=>J,RegisterSchema:()=>nt,Schema:()=>w,StateElement:()=>te,StateGroup:()=>ne,UserModel:()=>Y,UserSchema:()=>ve,checkAnyPermission:()=>Ve,checkPassword:()=>ct,checkPermission:()=>N,checkPermissions:()=>Be,createSession:()=>B,devMode:()=>me,expandPermissions:()=>Je,genToken:()=>z,generateEvent:()=>at,getAllPermissions:()=>Ye,getApiUrl:()=>L,getAutoAPIPermission:()=>Qe,getConfig:()=>q,getDeviceToken:()=>ut,getEnv:()=>et,getLogger:()=>I,getPendingResult:()=>j,getServiceToken:()=>lt,getTemplate:()=>it,gridSizes:()=>ht,hasPermission:()=>qe,hash:()=>dt,initSchemaSystem:()=>$,isAdmin:()=>Ge,isElectron:()=>M,isValidPermission:()=>Xe,matchesPermission:()=>ye,requireAuth:()=>ge,setApiUrl:()=>We,setConfig:()=>Le,templates:()=>_e,verifyToken:()=>pt,z:()=>c.z});module.exports=Ne(m);var p={};ae(p,{BaseSchema:()=>D,Schema:()=>w,initSchemaSystem:()=>$,z:()=>c.z});var g=T(require("zod"));var U,Ze=new Uint8Array(16);function W(){if(!U&&(U=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!U))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return U(Ze)}var y=[];for(let t=0;t<256;++t)y.push((t+256).toString(16).slice(1));function de(t,e=0){return(y[t[e+0]]+y[t[e+1]]+y[t[e+2]]+y[t[e+3]]+"-"+y[t[e+4]]+y[t[e+5]]+"-"+y[t[e+6]]+y[t[e+7]]+"-"+y[t[e+8]]+y[t[e+9]]+"-"+y[t[e+10]]+y[t[e+11]]+y[t[e+12]]+y[t[e+13]]+y[t[e+14]]+y[t[e+15]]).toLowerCase()}var Ce=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),H={randomUUID:Ce};function Ue(t,e,n){if(H.randomUUID&&!e&&!t)return H.randomUUID();t=t||{};let r=t.random||(t.rng||W)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){n=n||0;for(let s=0;s<16;++s)e[n+s]=r[s];return e}return de(r)}var K=Ue;var ce=T(require("moment")),c=require("zod");u(p,require("zod"));$();var w=g.z;c.z.relation=function(e,n){return c.z.object({relationId:c.z.string(),model:c.z.string(),displayField:c.z.string()}).relation(e,n)};var P=(t,e,n,r,s)=>(t._def.events||(t._def.events=[]),t._def.events.push({eventName:e,eventHandler:n,eventContext:r??"server",eventParams:s}),t);function Me(t){t.prototype.indexed=function(e){return this._def.indexed=!0,this._def.indexFn=e,this},t.prototype.groupIndex=function(e,n){return this._def.groupIndex=!0,this._def.groupName=e,this._def.groupCode=n,this},t.prototype.linkTo=function(e,n,r,s,i){return this._def.linkTo=e,this._def.linkToId=n,this._def.linkToReadIds=r,this._def.getDisplayField=s,this._def.linkToOptions=i??{},this},t.prototype.relation=function(e,n){return this._def.relation={model:e,displayField:n},this},t.prototype.synthesize=function(e){return this._def.synthesize=e,this},t.prototype.label=function(e){return this._def.label=e,this},t.prototype.hint=function(e){return this._def.hint=e,this},t.prototype.datePicker=function(e){return this._def.datePicker=e,this._def.coerce=!0,this},t.prototype.sequence=function(){return this._def.sequence=!0,this},t.prototype.name=function(e){return this._def.keyName=e,this},t.prototype.display=function(e){return this._def.display=e||["*"],this},t.prototype.columnWidth=function(e){return this._def.columnWidth=e,this},t.prototype.hidden=function(e){return this._def.hidden=e||["*"],this},t.prototype.generate=function(e,n){return this._def.generate={generator:e,force:n},this},t.prototype.before=function(e){return this._def.before=e,this},t.prototype.after=function(e){return this._def.after=e,this},t.prototype.dependsOn=function(e,n){return this._def.dependsOn=e,this._def.dependsOnValue=n,this},t.prototype.help=function(e){return this._def.help=e,this},t.prototype.generateOptions=function(e){return this._def.generateOptions=e,this},t.prototype.visible=function(e){return this._def.visible=e,this},t.prototype.choices=function(){return this._def.choices=!0,this},t.prototype.displayOptions=function(e){return this._def.displayOptions=e,this},t.prototype.secret=function(){return this._def.secret=!0,this},t.prototype.static=function(){return this._def.static=!0,this},t.prototype.id=function(){return this._def.id=!0,this._def.indexed=!0,this},t.prototype.search=function(e=!0){return this._def.search=e,this},t.prototype.filter=function(e=!0){return this._def.filter=e,this},t.prototype.size=function(e){return this._def.size=e,this},t.prototype.color=function(){return this._def.color=!0,this},t.prototype.textArea=function(e=300){return this._def.textArea=!0,this._def.textAreaHeight=e,this},t.prototype.file=function({initialPath:e,extensions:n}){return this._def.file=!0,this._def.initialPath=e,this._def.extensions=n??["*"],this},t.prototype.location=function(e,n,r="point",s={},i={}){return this._def.latKey=e,this._def.lonKey=n,this._def.location=!0,this._def.locationType=r,this._def.locationOptions=s,this._def.locationStyle=i,this},t.prototype.group=function(e){return this._def.group=e,this},t.prototype.defaultValue=function(e){return this._def.defaultValue=e,this},t.prototype.on=function(e,n,r,s){return P(this,e,n,r,s)},t.prototype.onList=function(e,n,r){return P(this,"list",e,n,r)},t.prototype.onCreate=function(e,n,r){return P(this,"create",e,n,r)},t.prototype.onRead=function(e,n,r){return P(this,"read",e,n,r)},t.prototype.onUpdate=function(e,n,r){return P(this,"update",e,n,r)},t.prototype.onDelete=function(e,n,r){return P(this,"delete",e,n,r)}}function $(){[g.ZodString,g.ZodNumber,g.ZodBoolean,g.ZodArray,g.ZodAny,g.ZodOptional,g.ZodUnion,g.ZodObject,g.ZodRecord,g.ZodDate].forEach(e=>Me(e))}var D=w.object({id:w.string().generate(()=>(0,ce.default)().format("YYYYMM-DDHHmm-ssSSS")+"-"+K().split("-")[0]).hidden().id()});u(m,p,module.exports);var B=(t,e)=>({user:{admin:t?.admin?t?.admin:!1,id:t?.id?t.id:"guest",type:t?.id?t?.type?t.type:"user":"guest",permissions:t?.permissions?t?.permissions:[],network:t?.network?t.network:"vento"},token:e||"",loggedIn:!!t?.id});var A=class t{constructor(e){this.shape=e}getFields(){return Object.keys(this.shape)}getDefinition(){let e={};return Object.keys(this.shape).forEach(n=>{e[n]={type:this.shape[n]._def.typeName.replace("Zod","").toLowerCase(),description:this.shape[n]._def.hint||"",isId:this.shape[n]._def.id||!1,autogenerate:!!this.shape[n]._def.generate}}),e}getFieldKeyDefinition(e,n){return this.shape[e]?this.shape[e]._def[n]:void 0}getFieldDefinition(e){return this.shape[e]?this.shape[e]._def:void 0}applyGenerators(e){let n={...e};return Object.keys(this.shape).forEach(r=>{if(this.shape[r]._def.generate){let s=this.shape[r]._def.generate;(!e[r]||s.force)&&(n[r]=typeof s.generator=="function"?s.generator(e):s.generator)}}),n}async apply(e,n,r,s){let i={...n},o=this.is("events"),a=Object.keys(o.shape);for(var d=0;d<a.length;d++){let h=a[d],b=o.shape[h],v=typeof process<"u"&&process.versions&&process.versions.node,S=b._def.events.filter(x=>x.eventName==e&&(!x.eventContext||x.eventContext=="client"&&!v||x.eventContext=="server"&&v));for(var l=0;l<S.length;l++){let x=S[l];r[x.eventHandler]&&(i=await r[x.eventHandler](h,x,i,s))}}return i}getLayout(e){let n=[[]],r=0;return Object.keys(this.shape).forEach(s=>{let i=this.shape[s];n[r].length==e&&(n.push([]),r++),n[r].push({...i,name:s})}),n}getFirst(e){return Object.keys(this.shape).find(n=>{if(this.shape[n]._def[e])return n})}getLast(e){let n;return Object.keys(this.shape).forEach(r=>{this.shape[r]._def[e]&&(n=r)}),n}isDisplay(e){let n={};return Object.keys(this.shape).forEach(r=>{(!this.shape[r]._def.display||this.shape[r]._def.display.includes("*")||this.shape[r]._def.display.includes(e))&&(!this.shape[r]._def.hidden||!this.shape[r]._def.hidden.includes("*")&&!this.shape[r]._def.hidden.includes(e))&&(n[r]=this.shape[r])}),new t(n)}isVisible(e,n){let r=this.isDisplay(e),s={};return Object.keys(r.shape).forEach(i=>{r.shape[i]._def.visible?r.shape[i]._def.visible(e,n)&&(s[i]=r.shape[i]):s[i]=r.shape[i]}),new t(s)}is(e){let n={};return Object.keys(this.shape).forEach(r=>{this.shape[r]._def[e]&&(n[r]=this.shape[r])}),new t(n)}isNot(e){let n={};return Object.keys(this.shape).forEach(r=>{this.shape[r]._def[e]||(n[r]=this.shape[r])}),new t(n)}isAfter(e){let n={};return Object.keys(this.shape).forEach(r=>{this.shape[r]._def?.after&&this.shape[r]._def.after==e&&(n[r]=this.shape[r])}),new t(n)}isBefore(e){let n={};return Object.keys(this.shape).forEach(r=>{this.shape[r]._def?.before&&this.shape[r]._def.before==e&&(n[r]=this.shape[r])}),new t(n)}merge(e){let n={};return Object.keys(this.shape).forEach(r=>{let s=e.isBefore(r);n={...n,...s.shape},n[r]=this.shape[r];let i=e.isAfter(r);n={...n,...i.shape}}),new t(n)}static load(e){return new t(e.shape)}};var pe=T(require("pino"));var V={},Le=t=>(V=t,V),q=()=>V;var ke=(t,e)=>n=>(r,s)=>typeof r=="string"?n.call(t,{audience:e},r):r instanceof Error?n.call(t,{audience:e,err:r},s??r.message):n.call(t,{audience:e,data:r},s),ze=(t,e)=>{let n=ke(t,e);return{fatal:n(t.fatal),error:n(t.error),warn:n(t.warn),info:n(t.info),debug:n(t.debug),trace:n(t.trace)}},I=(t,e)=>{let n=e??q(),r=(0,pe.default)(n.logger),s=r;return t&&typeof t!="string"&&(s=r.child({_meta:{...t}})),{error:(i,o,a)=>s.error(i,o),fatal:(i,o,a)=>s.fatal(i,o),warn:(i,o,a)=>s.warn(i,o),info:(i,o,a)=>s.info(i,o),debug:(i,o,a)=>s.debug(i,o),trace:(i,o,a)=>s.trace(i,o),ui:ze(s,"ui")}};var j=(t,e,n)=>({status:t,data:e,error:n||null,isError:t=="error",isLoading:t=="loading",isLoaded:t=="loaded",isPending:t=="pending"});function M(){return typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"}var le=I(),he="http://localhost:8000",We=t=>he=t,L=()=>process?.env?.PROXY_API_URL??he,ue=t=>new Promise(e=>setTimeout(e,t)),O=async(t,e,n,r,s=10)=>{let i=L(),o;if(typeof t=="string")o=typeof window>"u"||M()?(!t.startsWith("https://")&&!t.startsWith("http://")&&!t.startsWith("app://")?i:"")+t:t;else if(typeof t=="object"&&t.url){let d=typeof window>"u"||M()?(!t.url.startsWith("https://")&&!t.url.startsWith("http://")&&!t.startsWith("app://")?i:"")+t.url:t.url,l=new URLSearchParams;for(let h in t)h!=="url"&&l.append(h,t[h]);o=d+(d.includes("?")?"&":"?")+l.toString()}else throw new Error("Invalid params for API");let a=async()=>{n&&n(j("loading"));try{let d=await fetch(o,e?{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}:void 0),l;try{l=await d.text(),r||(l=JSON.parse(l))}catch{}if(!d.ok){let b=d.headers.get("content-type").includes("text/html")||typeof l=="string"&&l.trim().toLowerCase().startsWith("<!doctype"),v=new URL(o,L()).origin,S=new URL(L()).origin;if(b&&v===S&&d.status===404&&(l="404 API unavailable or address not found. The API service may be down or failed to start. Check API logs and database settings."),s>0&&(d.status<400||d.status>499)&&d.status!==500)return console.error("API retry: ",d.status,o),await ue(1e3),O(t,e,n,r,s-1);let R=j("error",null,l);if(n)n(R);else return R;return}let h=j("loaded",l);if(n)n(h);else return h}catch(d){if(le.trace("API retry: ",{realUrl:o,urlOrData:t,data:e,update:n,plain:r,retryNum:s}),s>0)return await ue(2e3),O(t,e,n,r,s-1);let l=d.apiError??d.toString();d instanceof SyntaxError&&(le.error({error:d},"Fetch error"),l="Server error. Check configuration and network connection.");let h=j("error",null,l);if(n)n(h);else return h}};if(n)a();else return a()},E={actionFetch:(...t)=>()=>O(...t),fetch:O,get:(t,e,n,r)=>O(t,null,e,n,r),post:(t,e,n,r,s)=>O(t,e,n,r,s)};var fe=I();function He(t){let e=/(\w+):("[^"]+"|\S+)/g,n={},r,s=t;for(;(r=e.exec(t))!==null;){let i=r[1].toLowerCase(),o=r[2].replace(/"/g,"").toLowerCase();n[i]=o,s=s.replace(r[0],"")}return s=s.trim(),{parsed:n,searchWithoutTags:s}}var _=class{constructor(e,n,r,s){this.data=e,this.session=r??B(),this.schema=n.extend({}),this.objectSchema=A.load(this.schema),this.modelName=s?.toLowerCase()??"unknown",this.idField=this.objectSchema.is("id").getLast("id")??"id",this.indexes={primary:this.idField,keys:this.objectSchema.is("indexed").getFields()};let i=this.objectSchema.is("groupIndex"),o=i.getFields();this.groupIndexes=o.map(a=>({key:a,name:i.getFieldKeyDefinition(a,"groupName")??a,fn:i.getFieldKeyDefinition(a,"groupCode")}))}static getClassFromDefinition(e){let n=a=>(a??[]).map(d=>{if(typeof d!="string")return d;let l=d.trim();if(!l.length)return d;try{return Function("z",`"use strict"; return (${l});`)(c.z)}catch{return d}}),r=w.object(Object.keys(e.keys).reduce((a,d)=>{let l=e.keys[d],h=c.z;if(typeof h[l.type]!="function")throw new Error(`Type ${l.type} does not exist on z`);return h=h[l.type](...n(l.params)),l.modifiers&&l.modifiers.forEach(b=>{let v=b.name,S=n(b.params);if(typeof h[v]=="function")h=h[v](...S);else throw new Error(`Modifier ${v} does not exist on z`)}),a[d]=h,a},{})),s=Object.keys(r.shape).some(a=>r.shape[a]._def.id),i=w.object({...s?{}:D.shape,...r.shape});return k.createDerived(e.id,i,e.apiOptions.name,e.apiOptions.prefix)}get(e,n){return this.data[e]??n}static getObjectSchema(){return this._newInstance({}).getObjectSchema()}getObjectSchema(){return this.objectSchema}static getGroupIndexes(){return this._newInstance({}).getGroupIndexes()}getGroupIndexes(){return this.groupIndexes}static getIndexes(){return this._newInstance({}).getIndexes()}getIndexes(){return this.indexes}static getSchemaLinks(){return this._newInstance({}).getSchemaLinks()}getSchemaLinks(){return this.objectSchema.is("linkTo").getFields().map(e=>{let{linkTo:n,linkToId:r,linkToReadIds:s,displayKey:i,linkToOptions:o}=this.objectSchema.getFieldDefinition(e);return{field:e,linkTo:n,linkToId:r,linkToReadIds:s,displayKey:i,linkToOptions:o}})}static getObjectFields(){return this._newInstance({}).getObjectFields()}getObjectFields(){return this.objectSchema.getFields()}static getObjectFieldsDefinition(){return this._newInstance({}).getObjectFieldsDefinition()}getObjectFieldsDefinition(){return this.objectSchema.getDefinition()}static getModelName(){return this._newInstance({}).getModelName()}getModelName(){return this.modelName}getLocation(){let e=this.objectSchema.is("location").getFields();if(!e.length)throw"Model error: "+this.getModelName()+" doesn't have location information";let n=e[0],r=this.objectSchema.getFieldKeyDefinition(n,"latKey"),s=this.objectSchema.getFieldKeyDefinition(n,"lonKey");if(this.data[n])return{type:this.objectSchema.getFieldKeyDefinition(n,"locationType"),style:this.objectSchema.getFieldKeyDefinition(n,"locationStyle"),options:this.objectSchema.getFieldKeyDefinition(n,"locationOptions"),lat:this.data[n][r],lon:this.data[n][s]}}static getIdField(){return this.getObjectSchema().is("id").getLast("id")??"id"}getId(){return this.data[this.idField]}static getSequeceField(){return this._newInstance({}).getSequeceField()}getSequeceField(){return this.objectSchema.getFields().find(e=>{let{sequence:n}=this.objectSchema.getFieldDefinition(e);return n})}canTransition(e){return!0}getNotificationsTopic(e){return e?`notifications/${this.getModelName()}/${e}/${this.getId()}`:`notifications/${this.getModelName()}/#`}static getNotificationsTopic(){return this._newInstance({}).getNotificationsTopic()}getNotificationsPayload(){return this.serialize()}setId(e,n){return new this.constructor({...n||this.data,[this.idField]:e},this.session,this.modelName)}isVisible(){return!0}list(e,n,r,s,i){if(!(s&&s.filter&&!Object.keys(s.filter).every(a=>{if(s.filter[a].from||s.filter[a].to){let d=!0;return s.filter[a].from&&this.data&&this.data[a]<s.filter[a].from&&(d=!1),s.filter[a].to&&this.data&&this.data[a]>s.filter[a].to&&(d=!1),d}else return this.data&&this.data[a]?.toString()==s.filter[a]})))if(i){try{if(new Function("element","session","extraData",i+`
 return filter_element(element, session, extraData);`)(this,n,r)===!1)return}catch(o){fe.error({error:o},`Error executing JS code: ${i}`);return}return this.read()}else if(e){let{parsed:o,searchWithoutTags:a}=He(e);for(let[l,h]of Object.entries(o))if(!this.data.hasOwnProperty(l)||this.data[l]!=h)return;let d=(l,h,b,v=[])=>{for(let S in l.shape){let x=l.shape[S];if(x._def.typeName==="ZodObject"){if(d(x,h[S],b,[...v,S]))return!0}else if(x._def.search||x._def?.innerType?._def?.search){let R=[...v,S].reduce((oe,je)=>oe&&oe[je],this.data);if(R&&R.toString().toLowerCase().includes(b.toLowerCase()))return!0}}return!1};if(d(this.objectSchema,this.data,a))return this.read()}else return this.read()}async listTransformed(e,n={},r,s,i,o){let a=this.list(e,r,s,i,o);if(a)return await this.getObjectSchema().apply("list",a,n)}static getAdditionalDescriptions(){return""}create(e){let n=this.getData(e);return fe.trace({transformed:n},`Creating object: ${JSON.stringify(n)}`),new this.constructor(n,this.session,this.modelName).validate()}async createTransformed(e={}){let n=await this.getObjectSchema().apply("create",{...this.data},e);return this.create(n)}read(e){return{...this.data}}async readTransformed(e={},n){return await this.getObjectSchema().apply("read",this.read(n),e)}update(e,n){return e.setId(this.getId(),{...n||e.data})}async updateTransformed(e,n={}){let r=await this.getObjectSchema().apply("update",{...e.data},n,{...this.data});return this.update(e,r)}delete(e){return new this.constructor({...e||this.data},this.session,this.modelName)}async deleteTransformed(e={}){let n=await this.getObjectSchema().apply("delete",{...this.data},e);return this.delete(n)}validate(){return this.schema.parse(this.data),this}serialize(e){return e?this.data:JSON.stringify(this.data)}static linkTo(e,n){return this._newInstance({}).linkTo(e,n)}linkTo(e,n){let r=this.constructor.getApiEndPoint();return this.schema.linkTo(async(s,i)=>{let o=i(r+(s?"?search="+s:""));return(await E.get(o)).data?.items??[]},s=>s[this.idField],async(s,i,o)=>{let a=await E.post(r+"?action=read_multiple",i);if(a.data&&a.data.length)for(let d of o){let l=d[s.field],h=a.data.find(b=>b[this.idField]==l);h&&(d[s.field]=h)}return o},e,n)}static getApiOptions(){throw new Error("Derived class must implement getApiOptions")}static _newInstance(e,n){throw new Error("Derived class must implement _newInstance.")}static unserialize(e,n){return this._newInstance(JSON.parse(e),n)}static getApiEndPoint(){let e=this.getApiOptions();return(e.prefix.endsWith("/")?e.prefix.slice(0,-1):e.prefix)+"/"+e.name}static load(e,n){return this._newInstance(e??{},n)}getData(e){return{...this.getObjectSchema().applyGenerators(e??this.data)}}},k=class t extends _{constructor(e,n,r,s){super(e,n,r,s)}static _newInstance(e,n){throw new Error("Derived class must implement _newInstance.")}static createDerived(e,n,r,s){let o=class o extends t{constructor(d,l){super(d,n,l,e.substring(0,e.length-5).toLowerCase())}static _newInstance(d,l){return new o(d,l)}static getApiOptions(){return{name:r,prefix:s}}};o.schemaInstance=n;let i=o;return Object.defineProperty(i,"name",{value:e,writable:!1}),i}};var G=class t{constructor(e){this.items=e}getData(){return this.items.map(e=>e.getData())}filter(e){return new t(this.items.filter(e))}static load(e,n){return new t(e.map(r=>new n(r)))}};var me=!1;process&&process.env.NODE_ENV==="development"&&(me=!0);var Ke=["read","create","update","delete","execute","*"],F={boards:["read","create","update","delete","execute"],cards:["read","create","update","delete","execute"],devices:["read","create","update","delete"],deviceDefinitions:["read","create","update","delete"],deviceBoards:["read","create","update","delete"],deviceCores:["read","create","update","delete"],deviceSdks:["read","create","update","delete"],enrollments:["read","approve","reject"],objects:["read","create","update","delete"],databases:["read","create","update","delete","backup"],users:["read","create","update","delete"],groups:["read","create","update","delete"],apis:["read","create","update","delete"],chatbots:["read","create","update","delete"],stateMachines:["read","create","update","delete","execute"],automations:["read","create","update","delete"],llama:["read","execute"],chatgpt:["execute"],vision:["execute"],autopilot:["read","execute"],settings:["read","update"],keys:["read","create","update","delete"],themes:["read","create","update","delete"],files:["read","create","update","delete"],assets:["read","install"],events:["read"],messages:["read"],services:["read"],system:["reload","backup","endpoints"],tokens:["read","create","update","delete"],packages:["read","create","update","delete"],workspaces:["read"],logs:["read"],protomemdb:["read","update"],flow:["read","create","update","delete"],templates:["read","execute"],esphome:["read","update","execute"],resources:["read","create","update","delete"],wled:["read","execute"],arduino:["read","create","update","delete","execute"],mobile:["read","update"],visualui:["read","update"],sequences:["read","create","update","delete"],icons:["read"],network:["read"],php:["execute"]},$e={admin:["*"],user:["boards.*","cards.*","objects.*","apis.*","chatbots.*","stateMachines.*","automations.*","themes.*","files.read","files.create","files.update","devices.read","devices.update","llama.*","chatgpt.*","vision.*","autopilot.*","wled.*","arduino.*","esphome.*","mobile.*","visualui.*","sequences.*","flow.*","icons.read","network.read","deviceDefinitions.read","deviceBoards.read","deviceCores.read","deviceSdks.read","databases.read","users.read","groups.read","settings.read","settings.update","keys.read","events.read","messages.read","services.read","tokens.read","packages.read","workspaces.read","logs.read","assets.read","protomemdb.read"],viewer:["boards.read","boards.execute","cards.read","cards.execute","devices.read","objects.read","events.read","messages.read","protomemdb.read","icons.read","settings.read","groups.read"]},ge=t=>{if(!t||!t.loggedIn)throw"E_AUTH"};function ye(t,e){if(t==="*"||t===e)return!0;if(t.endsWith(".*")){let n=t.slice(0,-2),[r]=e.split(".");if(n===r)return!0}return!1}function N(t,e){return t?.user?t.user.admin===!0?!0:t.user.permissions?t.user.permissions.some(n=>ye(n,e)):!1:!1}function Be(t,e){return e.every(n=>N(t,n))}function Ve(t,e){return e.some(n=>N(t,n))}var qe=(t,e)=>{if(ge(t),!N(t,e))throw"E_PERM"};function Ge(t){return t?.user?t.user.admin===!0||N(t,"*"):!1}function Je(t){let e=new Set;for(let n of t)if(n==="*")for(let[r,s]of Object.entries(F))for(let i of s)e.add(`${r}.${i}`);else if(n.endsWith(".*")){let r=n.slice(0,-2),s=F[r];if(s)for(let i of s)e.add(`${r}.${i}`)}else e.add(n);return Array.from(e)}function Ye(){let t=["*"];for(let[e,n]of Object.entries(F)){t.push(`${e}.*`);for(let r of n)t.push(`${e}.${r}`)}return t}function Xe(t){if(t==="*")return!0;let[e,n]=t.split(".");if(!e||!n)return!1;if(n==="*")return e in F;let r=F[e];return r?r.includes(n):!1}var xe={list:"read",read:"read",create:"create",update:"update",delete:"delete"};function Qe(t,e){let n=xe[e]||e;return`${t}.${n}`}var et=()=>process.env.NODE_ENV==="development"?"dev":"prod";var J=(t,e)=>e;var be=T(require("moment"));var ve=w.object({username:c.z.string().label("username").hint("admin, john, ...").static().id().search(),type:c.z.string().min(1).label("group").hint("user, admin, ...").search().generate("user").help("The type refers to a group name. Groups contains privileges (admin true/false) and workspaces.").indexed(),password:c.z.string().min(6).hint("**********").secret().hidden(["sheet","list","preview"]).onCreate("cypher").onUpdate("update").onRead("clearPassword").onList("clearPassword").help("Salted hashed password using bcrypt."),permissions:c.z.array(c.z.string()).optional().label("additional permissions"),network:c.z.string().min(1).label("network").hint("vento, custom-network, ...").search().generate("vento").help("The network this user belongs to.").indexed(),createdAt:c.z.string().min(1).generate(t=>(0,be.default)().toISOString()).search().hidden(["edit","add"]).indexed(),lastLogin:c.z.string().optional().search().hidden(["edit","add"]).indexed(),from:c.z.string().min(1).search().generate(t=>"admin").help("Interface used to create the user. Users can be created from command line or from the admin panel").hidden(["edit","add"])}),Y=class t extends _{constructor(e,n){super(e,ve,n,"User")}static load(e,n){return this._newInstance(e,n)}static _newInstance(e,n){return new t(e,n)}};var tt=c.z.object({username:c.z.string().min(1),password:c.z.string().min(1)}),Se=c.z.object({username:c.z.string().min(1),password:c.z.string().min(1),rePassword:c.z.any()}),nt=Se.refine(t=>t.password===t.rePassword,{message:"Passwords do not match",path:["password"]}),rt=c.z.object({type:c.z.string().min(1)}),st=c.z.object({...Se.omit({rePassword:!0}).shape,...rt.shape});var X=T(require("handlebars"));var we=I(),Te=async(t,e,n)=>{we.info({template:{path:e,params:n}},"Template file executed");let r=e;if(t.fs.existsSync(r))throw"File already exists";let s="../../"+n?.data?.options?.template;if(!n?.data?.options?.template||!t.fs.existsSync(s))throw"There is a problem with your workspace definition. No template file was provided for this template.";let i=(await t.fs.promises.readFile(s)).toString();X.default.registerHelper("curlyBraces",function(d){var l=d.fn(this);return"{{"+l+"}}"});let a=X.default.compile(i)({name:n.name,...n.data?.options?.variables});await t.fs.promises.writeFile(r,a),we.info({template:r},"New file created with template file")};var _e={file:Te},it=t=>_e[t];var f={},ot=t=>(f[t]||(f[t]={}),{set:(e,n,r,s)=>{f[t][e]=f[t][e]||{},f[t][e][n]=f[t][e][n]||{},f[t][e][n][r]=s},get:(e,n,r)=>f[t][e]&&f[t][e][n]&&f[t][e][n][r],getTags:e=>f[t][e]?Object.keys(f[t][e]):[],getByTag:(e,n)=>f[t][e]&&f[t][e][n],getByGroup:e=>f[t][e],remove:(e,n,r)=>{f[t][e]&&f[t][e][n]&&delete f[t][e][n][r]},clear:(e,n)=>{f[t][e]&&delete f[t][e][n]},clearGroup:e=>{delete f[t][e]},clearAll:()=>{f[t]={}},getState:()=>f[t],setState:e=>{f[t]=e},setGroupState:(e,n)=>{f[t][e]=n}});var Q=class{constructor(e){this.automationData=e}getData(e){return e?this.automationData:{action:{...this.automationData}}}},ee=class{constructor(e,n){this.actions=e,this.name=n}getActionByName(e){return this.actions.find(n=>n.automationData.name===e)}getActions(){return this.actions}getData(){return{[this.name]:this.actions.map(e=>e.getData())}}},te=class{constructor(e,n){this.name=e,this.value=n}getData(){let e=this.value;return{[this.name]:e}}},ne=class{constructor(e,n){this.states=e,this.name=n}addState(e){return this.states.push(e),this}getDataArray(){return this.states.map(e=>e.getData())}getDataObject(){let e={};return this.states.forEach(n=>{e={...e,...n.getData()}}),e}getData(){return{[this.name]:this.states.map(e=>e.getData())}}};var Ie=T(require("moment"));var Pe=c.z.object(J("schema",{path:c.z.string().search().groupIndex("path","return data.path.split('/').reduce((acc, curr, index) => (acc.push(index === 0 ? curr : acc[index - 1] + '/' + curr), acc), [])"),from:c.z.string().search(),user:c.z.string().generate(t=>"me").search(),environment:c.z.enum(["dev","prod"]).optional(),payload:c.z.record(c.z.string(),c.z.any()).search(),ephemeral:c.z.boolean().optional(),created:c.z.string().generate(t=>(0,Ie.default)().toISOString()).search().indexed()})),De=c.z.object({...D.shape,...Pe.shape}),re=class t extends _{constructor(e,n){super(e,De,n,"Event")}list(e,n,r,s,i){if(s&&s.filter&&s.filter.path){let{path:o,...a}=s.filter;if(!this.data.path||!this.data.path.startsWith||!this.data.path.startsWith(o))return;s={...s,filter:{...a}}}return super.list(e,n,r,s,i)}getNotificationsTopic(e){return`notifications/${this.getModelName()}/${e}/${this.data.path}`}static _newInstance(e,n){return new t(e,n)}},at=async(t,e="")=>{try{await E.post("/api/core/v1/events?token="+e,t,void 0,!0)}catch{}};var se=T(require("bcryptjs")),ie=T(require("jsonwebtoken")),dt=async t=>se.default.hash(t,10),ct=async(t,e)=>se.default.compare(t,e),z=(t,e={expiresIn:"3600000s"})=>{if(process.env.TOKEN_SECRET)return ie.default.sign(t,process.env.TOKEN_SECRET,e)},pt=t=>ie.default.verify(t,process.env.TOKEN_SECRET??"");var lt=()=>z({id:"system",type:"system",admin:!0}),ut=(t,e=!1)=>z({id:t,type:"device",admin:e},{expiresIn:"5y"});var ht={lg:{totalCols:90,normalW:30,normalH:6,doubleW:30,doubleH:6},md:{totalCols:64,normalW:30,normalH:6,doubleW:30,doubleH:6},sm:{totalCols:2,normalW:2,normalH:6,doubleW:2,doubleH:6},xs:{totalCols:1,normalW:1,normalH:6,doubleW:1,doubleH:6}};
