var P=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var A=(e,t)=>{for(var u in t)P(e,u,{get:t[u],enumerable:!0})},O=(e,t,u,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of T(t))!V.call(e,i)&&i!==u&&P(e,i,{get:()=>t[i],enumerable:!(n=C(t,i))||n.enumerable});return e};var $=e=>O(P({},"__esModule",{value:!0}),e);var q={};A(q,{boardConnect:()=>W,resolveBoardParam:()=>m});module.exports=$(q);var j=require("protobase"),x=require("protonode"),E=j.API;function N(e){return e.replace(/\?\./g,".").replace(/\[(["']?)(.*?)\1\]/g,".$2").split(".").filter(Boolean)}function w(e,t,u){return N(t).reduce((n,i)=>n?.[i],e)??u}var J=(e,t,u)=>{switch(t){case"string":return String(e);case"number":return Number(e);case"boolean":return e==="true"||e===!0;case"json":try{return JSON.parse(e)}catch{return{}}case"array":try{return JSON.parse(e)}catch{return[]}case"card":return e;case"text":return e;case"state":return JSON.stringify(w(u,e));default:return e}},R=e=>typeof e!="string"?!1:e.startsWith("board.")||e.startsWith("board?.")||e.startsWith("board[")||e.startsWith("board?.["),U=e=>N(e)[1],m=async({states:e,boardId:t,defaultValue:u,value:n,type:i,contextId:p=void 0,getContextState:g=void 0})=>{let r=!1;(n==null||n==="")&&(n=u);let a=e?.boards?.[t]??{};if(p&&g){let d=a;a=new Proxy({},{get(l,b){let c=String(b),y=g(p,c);return y!==void 0?y:d[c]},has(l,b){let c=String(b);return g(p,c)!==void 0?!0:c in d}})}let o={board:a};if(R(n)){let d=U(n);p&&g&&g(p,d)!==void 0||e?.boards?.[t]&&e.boards[t][d]!==void 0?(n=w(o,n),r=!0):n=void 0}return n=J(n,i,o),n};function W(e){let t={},u=null,n=x.getServiceToken(),i={},p=({name:r,key:a=void 0,changed:o,inmediate:d=!1})=>{!r&&a&&(console.warn("onChange called with key but no name, using key as name. key is a deprected parameter, please use name instead."),r=a),i[r]||(i[r]=[]),i[r].push(o),d&&o(t.states[r])};async function g({name:r,board:a=void 0,params:o={},done:d=b=>{},error:l=b=>{}}){let b=a||t.boardId;if(console.log("Executing action boardConnect: ",r,"on board:",b,"params:",o),a&&a!==t.boardId){let f=`/api/core/v1/boards/${encodeURIComponent(a)}/actions/${encodeURIComponent(r)}`,h=x.getServiceToken();try{let s=await E.post(f+"?token="+h,o);if(s.isError){console.error("Error executing action on board "+a+": ",s.error),l(s.error);return}return d(s.data),s.data}catch(s){console.error("Error executing action on board "+a+": ",s),l(s);return}}let c=t.actions[r];if(!c){l("Action not found: "+r),console.error("Action not found: ",r);return}let y=c.url;if(console.log("Action: ",c),c.receiveBoard&&(o.board=t.boardId),c.configParams)for(let f in c.configParams)c.configParams&&c.configParams[f]&&(o[f]=await m({states:t.states,boardId:t.boardId,defaultValue:c.configParams[f].defaultValue,value:o[f],type:c.configParams[f]?.type}));if(c.method==="post"){let{token:f,...h}=o;c.token&&(f=c.token);let s=await E.post(y+"?token="+(f||x.getServiceToken()),h);if(s.isError){console.error("Error executing action: ",s.error),l(s.error);return}return d(s.data),s.data}else{let h=function(I){return Object.entries(I).filter(([,S])=>S!==void 0).map(([S,k])=>{let B=k!==null&&typeof k=="object"?JSON.stringify(k):String(k??"");return`${encodeURIComponent(S)}=${encodeURIComponent(B)}`}).join("&")}(o),s=await E.get(y+"?token="+n+"&"+h);if(s.isError){console.error("Error executing action: ",s.error),l(s.error);return}return d(s.data),s.data}}process.on("message",r=>{if(r.type==="init"){let a=r.boardContext||{};t=r.context,u=console.log.bind(console,"Board log ["+t.boardId+"]: ");try{e({context:a,...t,board:{onChange:p,execute_action:g,log:u,id:t.boardId}})}catch(o){console.error("Error running board ["+t.boardId+"]:",o)}process.send&&process.send({type:"init_confirmed"})}else if(r.type==="update"){let a=r.chunk,o=r.key,d=r.value;o?(t[a][o]=d,a=="states"&&i[o]&&i[o].forEach(l=>l(t.states[o]))):t[a]=d}})}0&&(module.exports={boardConnect,resolveBoardParam});
