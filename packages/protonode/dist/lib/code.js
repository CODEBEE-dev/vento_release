var T=Object.create;var m=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var K=(t,e)=>{for(var r in e)m(t,r,{get:e[r],enumerable:!0})},y=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of b(e))!F.call(t,s)&&s!==r&&m(t,s,{get:()=>e[s],enumerable:!(o=w(e,s))||o.enumerable});return t};var S=(t,e,r)=>(r=t!=null?T(j(t)):{},y(e||!t||!t.__esModule?m(r,"default",{value:t,enumerable:!0}):r,t)),L=t=>y(m({},"__esModule",{value:!0}),t);var q={};K(q,{ImportType:()=>N,addElementToArrayLiteral:()=>R,addFeature:()=>U,addImportToSourceFile:()=>M,addObjectLiteralProperty:()=>V,extractChainCalls:()=>$,getDefinition:()=>l,getDefinitions:()=>O,getImport:()=>P,getPropertyValueFromObjectLiteral:()=>z,getSourceFile:()=>I,hasFeature:()=>f,removeFeature:()=>Z,removeFileWithImports:()=>_,removeImportFromSourceFile:()=>A,removeObjectLiteralProperty:()=>v,toSourceFile:()=>C});module.exports=L(q);var n=require("ts-morph"),p=S(require("path"));var h=t=>process.env.FILES_ROOT??"../../";var E=require("protobase"),c=(0,E.getLogger)(),P=(t,e)=>{let r=t.getImportDeclarations();for(let o of r){let s=o.getNamedImports();for(let i of s)if(i.getName()===e)return o.getModuleSpecifierValue();let a=o.getDefaultImport();if(a&&a.getText()===e)return o.getModuleSpecifierValue()}},O=(t,e,r=1)=>t.getDescendantsOfKind(n.SyntaxKind.CallExpression).filter(a=>{let i=a.getArguments(),g=a.getExpression();return g.getKind()===n.SyntaxKind.Identifier&&g.getText()==="Protofy"&&i.length&&i[0].getText()==e}).map(a=>a.getArguments()[r]),l=(t,e,r=1)=>{let s=t.getDescendantsOfKind(n.SyntaxKind.CallExpression).find(a=>{let i=a.getArguments(),g=a.getExpression();return g.getKind()===n.SyntaxKind.Identifier&&g.getText()==="Protofy"&&i.length&&i[0].getText()==e});return s?s.getArguments()[r]:void 0},I=t=>new n.Project().addSourceFileAtPath(t),C=t=>new n.Project({useInMemoryFileSystem:!0}).createSourceFile("_temp1.tsx",t,{overwrite:!0}),$=t=>{let e=[],r=t;for(;r&&r.getKind()===n.SyntaxKind.CallExpression;){let o={name:r.getExpression().getLastChild().getText(),params:r.getArguments().map(s=>s.getText())};e.unshift(o),r=r.getExpression().getFirstChildIfKind(n.SyntaxKind.CallExpression)}return e},N=(r=>(r[r.DEFAULT=0]="DEFAULT",r[r.NAMED=1]="NAMED",r))(N||{}),M=(t,e,r,o)=>{if(P(t,e)){c.warn(`"${e}" is already imported`);return}switch(r){case 0:t.addImportDeclaration({defaultImport:e,moduleSpecifier:o});break;case 1:t.addImportDeclaration({namedImports:[e],moduleSpecifier:o});break}},A=(t,e)=>{let r=t.getImportDeclarations();for(let o of r)if(o.getModuleSpecifierValue()===e){o.remove();break}},z=(t,e)=>{try{let r=t.getProperty(e);if(!r||r.getKind()!==n.SyntaxKind.PropertyAssignment)throw"Property doesn't exist";let o=r.asKindOrThrow(n.SyntaxKind.PropertyAssignment);if(!o||!o.getInitializer)throw"Property doesn't exist";let s=o.getInitializer();if(!s)throw"Property doesn't exist";return s}catch{console.log("Error retrieving property. Doesn't exist")}},R=(t,e)=>{try{if(!t||t.getKind()!==n.SyntaxKind.ArrayLiteralExpression)throw"Element is not an array";t.addElement(e)}catch{console.log("Error adding element to array literal")}},V=(t,e,r)=>{if(t.getProperty(i=>i instanceof n.PropertyAssignment&&(i.getNameNode().getKind()===n.SyntaxKind.Identifier&&i.getName()===e||i.getNameNode().getKind()===n.SyntaxKind.ComputedPropertyName&&i.getNameNode().getText()===`["${e}"]`))){c.warn(`Object already has key: "${e}".`);return}let a=/^[a-zA-Z_$][a-zA-Z\d_$]*$/.test(e)?e:`["${e}"]`;t.addPropertyAssignment({name:a,initializer:r})},v=(t,e)=>{let r=t.getProperty(o=>o instanceof n.PropertyAssignment&&(o.getNameNode().getKind()===n.SyntaxKind.Identifier&&o.getName()===e||o.getNameNode().getKind()===n.SyntaxKind.ComputedPropertyName&&o.getNameNode().getText()===`["${e}"]`));r?r.remove():c.warn(`Key "${e}" does not exist on the object.`)},_=async(t,e,r,o,s,a)=>{let i=e.name,g="./"+p.basename(i),d=I(p.join(t,o)),u=l(d,r);if(!u)throw"No link definition schema marker found for file: "+g;v(u,i),A(d,g),d.saveSync();let x=h(s)+"packages/app/"+r.replace(/"/g,"")+"/"+p.basename(e.name)+".ts";try{await a.unlink(x)}catch(D){c.error({error:D,filePath:x},"Error deleting file")}},f=(t,e)=>{let r=l(t,'"features"');return r?r.getProperty(e)!==void 0:(c.info("Cannot check for feature due to missing features marker"),!1)},U=async(t,e,r)=>{if(f(t,e)){c.info({feature:e},"Feature already exists, not adding");return}c.debug("Marker found, writing object"),l(t,'"features"').addPropertyAssignment({name:e,initializer:r}),await t.save()},Z=async(t,e)=>{if(!f(t,e)){c.error({feature:e},"Feature not found, cannot remove");return}c.debug("Marker found, removing object property"),l(t,'"features"').getProperty(e).remove(),await t.save()};0&&(module.exports={ImportType,addElementToArrayLiteral,addFeature,addImportToSourceFile,addObjectLiteralProperty,extractChainCalls,getDefinition,getDefinitions,getImport,getPropertyValueFromObjectLiteral,getSourceFile,hasFeature,removeFeature,removeFileWithImports,removeImportFromSourceFile,removeObjectLiteralProperty,toSourceFile});
