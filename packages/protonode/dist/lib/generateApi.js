var X=Object.defineProperty;var zt=Object.getOwnPropertyDescriptor;var Ot=Object.getOwnPropertyNames;var At=Object.prototype.hasOwnProperty;var Et=(r,a)=>{for(var u in a)X(r,u,{get:a[u],enumerable:!0})},Lt=(r,a,u,s)=>{if(a&&typeof a=="object"||typeof a=="function")for(let l of Ot(a))!At.call(r,l)&&l!==u&&X(r,l,{get:()=>a[l],enumerable:!(s=zt(a,l))||s.enumerable});return r};var Rt=r=>Lt(X({},"__esModule",{value:!0}),r);var Wt={};Et(Wt,{AutoAPI:()=>Kt});module.exports=Rt(Wt);var x=require("protobase");var S=require("protobase");var O=require("protobase");var Ut=(0,S.getLogger)(),Tt=r=>{let a,u;try{u=JSON.parse(r.cookies.session)}catch{u=null}var s="";let l=r.headers?.authorization;if(l&&l.startsWith("Bearer ")?s=l.slice(7):(r.query.token||u&&u.token)&&(s=r.query.token?r.query.token:u.token,Array.isArray(s)&&(s=s[0])),s)try{a=(0,S.createSession)((0,O.verifyToken)(s))}catch(m){Ut.error({error:m},"Error reading token"),a=(0,S.createSession)()}else a=(0,S.createSession)();return{session:a,token:s}},A=r=>async(a,u,s)=>{try{let l=Tt(a);await r(a,u,{...l.session,token:l.token},s)}catch(l){if(l instanceof S.ZodError){let m=l.flatten();u.status(400).send(m)}else l.toString()=="E_PERM"?u.status(403).send({error:l.toString()}):l.toString()=="E_AUTH"?u.status(401).send({error:l.toString()}):l.toString()=="File already exists"?u.status(409).send({error:l.toString()}):u.status(500).send({error:l.toString()})}};var I=require("protobase");var Y,jt=(r,a,u)=>Y.initDB(r,a,u),Mt=(r,a,u,s)=>Y.connect(r),_t=async()=>Y.closeDBS(),q={connectDB:jt,getDB:Mt,closeDBS:_t},pt=(r,a)=>({indexes:r.getIndexes(),groupIndexes:r.getGroupIndexes(),dbOptions:{batch:!1,batchLimit:100,batchTimeout:2e3,...a}});var $=require("protobase"),Jt=async r=>(await $.API.post("/api/agents/v1/llm_agent/agent_input?token="+(0,$.getServiceToken)(),{message:r})).data,$t=({prompt:r,done:a=async s=>s,error:u=s=>s})=>{let s=[{role:"system",content:[{type:"text",text:r}]}];return a(s),s},Ht=r=>{let a=r.replace(/^```[^\s]+/g,"").replace(/```/g,"").trim();return a.startsWith("javascript")&&(a=a.replace("javascript","").trim()),a};var tt={callModel:async r=>await Jt(r),cleanCode:r=>Ht(r),getSystemPrompt:r=>$t(r)};var E=(0,I.getLogger)(),Nt=q.getDB,Gt=q.connectDB;function U(r,a,u,s){if(s&&s[a])return r?.loggedIn?(0,I.checkPermission)(r,s[a])?{allowed:!0,status:200}:{allowed:!1,status:403}:{allowed:!1,status:401};if(u&&(u.includes(a)||u.includes("*"))){if(!r?.loggedIn)return{allowed:!1,status:401};if(!(0,I.isAdmin)(r))return{allowed:!1,status:403}}return{allowed:!0,status:200}}var Kt=({modelName:r,modelType:a,initialData:u={},prefix:s="/api/v1/",dbName:l,transformers:m={},connectDB:gt=Gt,getDB:z=Nt,notify:et,operations:v=["create","read","update","delete","list"],single:ht,disableEvents:H,paginatedRead:N,requiresAdmin:L,permissions:R,extraData:k={},logLevel:G="info",itemsPerPage:rt=25,allowUpsert:wt=!1,skipStorage:at=async(f,p,b)=>!1,onBeforeList:mt=async(f,p,b)=>f,onAfterList:nt=async(f,p,b)=>f,onBeforeCreate:kt=async(f,p,b)=>f,onAfterCreate:bt=async(f,p,b)=>f,onBeforeRead:ot=async(f,p,b)=>f,onAfterRead:K=async(f,p,b)=>f,onBeforeUpdate:It=async(f,p,b)=>f,onAfterUpdate:Pt=async(f,p,b)=>f,onBeforeDelete:it=async(f,p,b)=>f,onAfterDelete:St=async(f,p,b)=>f,skipDatabaseIndexes:st,dbOptions:ct={},defaultOrderBy:dt=void 0,defaultOrderDirection:ut="asc",skipDatabaseInitialization:Bt=!1,ephemeralEvents:W=!1})=>async(f,p)=>{let b=l??r,Dt=a.getGroupIndexes(),F=(t,n,e)=>l&&typeof l=="function"?l(t,n,e):b,Z=(t,n)=>{if(et)return et(t,n);p&&p.mqtt&&p.mqtt.publish(t.getNotificationsTopic(n),t.getNotificationsPayload())};Bt||await gt(F("init"),u,st?{}:pt(a,ct));let vt=async(t,n,e)=>(Dt.forEach(c=>{t[c.name]!==void 0&&(t.filter===void 0&&(t.filter={}),t.filter[c.key]=t[c.name])}),await mt(t,n,e)),lt=t=>{let n=a.getSchemaLinks();if(n){for(let e of n)if(t[e.field]!==void 0){let c=e.linkToId(t[e.field]);t[e.field]=c}}return t},T=async t=>{let n=a.getSchemaLinks();if(n)for(let e of n){let c=t.map(o=>o[e.field]).filter(o=>o!==void 0);c=[...new Set(c)],t=await e.linkToReadIds(e,c,t)}return t},ft=async(t,n,e)=>{let c=Number(t.query.page)||0,o=t.query.orderBy&&t.query.orderBy!=""?t.query.orderBy:dt,i=t.query.orderDirection&&t.query.orderDirection!=""?t.query.orderDirection:ut;return o&&(n=n.sort((d,h)=>d[o]>h[o]?i==="asc"?1:-1:d[o]<h[o]?i==="asc"?-1:1:0)),n=await T(n),{itemsPerPage:e,items:t.query.all?n:n.slice(c*e,(c+1)*e),total:n.length,page:t.query.all?0:c,pages:t.query.all?1:Math.ceil(n.length/e)}};!ht&&v.includes("list")&&f.get(s+r,A(async(t,n,e)=>{let c=U(e,"list",L,R);if(!c.allowed){n.status(c.status).send({error:c.status===401?"Unauthorized":"Forbidden"});return}let o=z(F("list",t),t,e,p);if(t.query.group){let g=[];if(o.hasCapability&&o.hasCapability("groupBySingle")&&(g=await o.getGroupIndexOptions(t.query.group,t.query.limit||100)),t.query.search){let w=t.query.search;g=g.filter(P=>P.toLowerCase().startsWith(w.toLowerCase()))}n.send(g);return}let i=[],y=t.query.search,d=a.getGroupIndexes().reduce((g,w)=>t.query[w.name]===void 0?g:g?(g[w.key]=t.query[w.name],g):{[w.key]:t.query[w.name]},null),h=t.query.filter;d&&(h?h={...h,...d}:h=d);let B=typeof k?.prelist=="function"?await k.prelist(e,t):k?.prelist??{},D=t.query.mode,C,j;if(y&&D=="ai"){let g=await I.API.get(s+r+"?token="+(0,x.getServiceToken)());g=g?.data?.items||[],g=JSON.stringify(g),C=await p.autopilot.getPromptFromTemplate({sampleElements:g,templateName:"aiSearch",search:y,modelName:r,modelType:a.toString(),modelDefinition:JSON.stringify(a.getObjectFieldsDefinition()),aditionalDecriptions:a.getAdditionalDescriptions()});let w=await tt.callModel(C);j=tt.cleanCode(w.choices[0].message.content)}let yt=async(g,w)=>{let P=a.unserialize(g,e),J=typeof k?.list=="function"?await k.list(e,P,t):k?.list??{};return await P.listTransformed(y,m,e,{...B,...J},w?void 0:await vt(t.query,e,t),j)},M=Math.max(Number(t.query.itemsPerPage)||(rt??25),1),_=Object.keys(h||{});if(!y&&(!h||(!t.query.orderBy||t.query.orderBy==a.getIdField())&&_.length==1&&o.hasCapability&&o.hasCapability("groupBySingle")&&await o.hasGroupIndexes(_))&&!st&&o.hasCapability&&o.hasCapability("pagination")){let g=await o.getIndexedKeys(),w=h?{key:_[0],value:h[_[0]]}:null,P=parseInt(await o.count(w),10),J=Number(t.query.page)||0,Q=t.query.orderBy?t.query.orderBy:dt??a.getIdField(),Ft=t.query.orderDirection||ut;if(g.length&&g.includes(Q)){let V=await Promise.all((await o.getPageItems(P,Q,J,M,Ft,w)).map(async xt=>await yt(xt,!0)));V=await T(V);let Ct={itemsPerPage:M,items:V,total:P,page:t.query.all?0:J,pages:t.query.all?1:Math.ceil(P/M)};n.send(await nt(Ct,e,t));return}}for await(let[g,w]of o.iterator()){let P=await yt(w);P&&i.push(P)}n.send(await nt(await ft(t,i,M),e,t))})),(v.includes("create")||v.includes("read"))&&f.post(s+r,A(async(t,n,e)=>{let c=t.query.action=="read_multiple"?"read":"create",o=U(e,c,L,R);if(!o.allowed){n.status(o.status).send({error:o.status===401?"Unauthorized":"Forbidden"});return}if(t.query.action=="read_multiple"){let d=t.body;if(!d||!d.length){n.status(400).send({error:"No ids provided"});return}let h=z(F("read",t),t,e,p),B=[];for(let D of d)try{let C=a.unserialize(await h.get(D),e),j=typeof k?.read=="function"?await k.read(e,C,t):k?.read??{};B.push(await K(await C.readTransformed(m,j),e,t))}catch(C){E.error({error:C},"Error reading item: "+D)}n.send(B);return}else if(!v.includes("create")){n.status(404).send({error:"Not found"});return}let i=await a.load(await kt(t.body,e,t),e).createTransformed(m);if(!(at?await at(i.read(),e,t):!1)){let d=F("create",t,i);d||n.status(404).send({error:"Not found"}),d instanceof Array||(d=[d]);for(let h of d){let B=z(h,t,e,p);try{if(wt)throw new Error("Upsert enabled, inserting new document");await B.get(i.getId()),n.status(409).send({error:"Already exists"});return}catch{await B.put(i.getId(),JSON.stringify(lt(i.serialize(!0))),{...ct,action:"create",entityId:a.getIdField()})}}}Z(i,"create"),H||(0,I.generateEvent)({path:r+"/create/"+i.getId(),from:"vento",user:e.user.id,payload:{id:i.getId(),data:i.read()},ephemeral:W??!1},(0,x.getServiceToken)()),E[G??"info"]({id:i.getId()},r+" created: "+i.getId()),n.send(await bt(await i.readTransformed(m),e,t))})),v.includes("read")&&f.get(s+r+"/:key",A(async(t,n,e)=>{let c=U(e,"read",L,R);if(!c.allowed){n.status(c.status).send({error:c.status===401?"Unauthorized":"Forbidden"});return}let o=z(F("read",t),t,e,p);try{if(N){let i=[],y=t.query.search;for await(let[d,h]of o.get(t.params.key))if(d!="initialized"){let D=await N.model.unserialize(await ot(h,e,t),e).listTransformed(y,m);D&&i.push({...D,_key:d})}n.send(await ft(t,await K(i,e,t),Math.max(Number(t.query.itemsPerPage)||(rt??25),1)))}else{let i=a.unserialize(await ot(await o.get(t.params.key),e,t),e),y=typeof k?.read=="function"?await k.read(e,i,t):k?.read??{},d=(await T([await i.readTransformed(m,y)]))[0];n.send(await K(d,e,t))}}catch(i){E.error({error:i},"Error reading from database"),n.status(404).send({result:"not found"})}})),v.includes("update")&&f.post(s+r+"/:key",A(async(t,n,e)=>{let c=U(e,"update",L,R);if(!c.allowed){n.status(c.status).send({error:c.status===401?"Unauthorized":"Forbidden"});return}let o=a.load(await It(t.body,t,e),e),i=z(F("update",t,o),t,e,p),y=(await T([JSON.parse(await i.get(t.params.key))]))[0],d=await a.load(y,e).updateTransformed(o,m),h=t?.query?.patch==="true";await i.put(d.getId(),JSON.stringify({...h?y:{},...lt(d.serialize(!0))})),Z(d,"update"),H||(0,I.generateEvent)({path:r+"/update/"+d.getId(),from:"vento",user:e.user.id,payload:{id:d.getId(),data:d.read()},ephemeral:W??!1},(0,x.getServiceToken)()),E[G??"info"]({data:d.read()},r+" updated: "+d.getId()),n.send(await Pt(await d.readTransformed(m),e,t))})),v.includes("delete")&&f.get(s+r+"/:key/delete",A(async(t,n,e)=>{let c=U(e,"delete",L,R);if(!c.allowed){n.status(c.status).send({error:c.status===401?"Unauthorized":"Forbidden"});return}let o=z(F("delete",t),t,e,p),i;try{i=await o.get(t.params.key)}catch{n.status(404).send({error:"Not found"});return}N?(await it("{}",e,t),await o.del(t.params.key,i)):(it(i,e,t),await o.del(t.params.key,i));try{let y=await a.unserialize(i,e);Z(y,"delete"),H||(0,I.generateEvent)({path:r+"/delete/"+y.getId(),from:"vento",user:e.user.id,payload:{who:"-",id:y.getId(),data:y.read()},ephemeral:W??!1},(0,x.getServiceToken)()),E[G??"info"]({data:y.read()},r+" deleted: "+y.getId())}catch(y){E.error({e:y},"Error during delete notification")}n.send(await St({result:"deleted"},e,t))}))};0&&(module.exports={AutoAPI});
