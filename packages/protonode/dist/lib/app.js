var x=Object.create;var c=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty;var q=(r,s)=>{for(var o in s)c(r,o,{get:s[o],enumerable:!0})},g=(r,s,o,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let e of v(s))!R.call(r,e)&&e!==o&&c(r,e,{get:()=>s[e],enumerable:!(t=S(s,e))||t.enumerable});return r};var l=(r,s,o)=>(o=r!=null?x(E(r)):{},g(s||!r||!r.__esModule?c(o,"default",{value:r,enumerable:!0}):o,r)),P=r=>g(c({},"__esModule",{value:!0}),r);var T={};q(T,{getApp:()=>H});module.exports=P(T);var p=l(require("express")),m=l(require("cookie-parser")),y=l(require("cors")),h=l(require("pino-http")),d=require("protobase");var i=require("protobase");var u=require("protobase");var A=(0,i.getLogger)(),b=r=>{let s,o;try{o=JSON.parse(r.cookies.session)}catch{o=null}var t="";let e=r.headers?.authorization;if(e&&e.startsWith("Bearer ")?t=e.slice(7):(r.query.token||o&&o.token)&&(t=r.query.token?r.query.token:o.token,Array.isArray(t)&&(t=t[0])),t)try{s=(0,i.createSession)((0,u.verifyToken)(t))}catch(a){A.error({error:a},"Error reading token"),s=(0,i.createSession)()}else s=(0,i.createSession)();return{session:s,token:t}},f=r=>async(s,o,t)=>{try{let e=b(s);await r(s,o,{...e.session,token:e.token},t)}catch(e){if(e instanceof i.ZodError){let a=e.flatten();o.status(400).send(a)}else e.toString()=="E_PERM"?o.status(403).send({error:e.toString()}):e.toString()=="E_AUTH"?o.status(401).send({error:e.toString()}):e.toString()=="File already exists"?o.status(409).send({error:e.toString()}):o.status(500).send({error:e.toString()})}};var k=l(require("express-list-endpoints")),n,H=(r=s=>{})=>{if(!n){let s=(0,d.getLogger)(),o=(0,d.getConfig)();n=(0,p.default)(),r(n),n.set("json spaces",2),n.use((0,y.default)()),n.use((0,m.default)()),n.use(p.default.json({limit:"50mb"})),n.use((0,h.default)({customSuccessMessage:function(t,e){return`${t.method} ${t.originalUrl} - ${e.statusCode}`},serializers:{req:t=>process.env.NODE_ENV==="development"?{method:t.method,url:t.url}:t,res:t=>process.env.NODE_ENV==="development"?{code:t.statusCode}:t},...o.logger,useLevel:"trace"})),n.get(global.defaultRoute+"/endpoints",f(async(t,e,a,z)=>{(0,d.hasPermission)(a,"admin/endpoints/list"),e.send((0,k.default)(n))})),s.debug({route:global.defaultRoute},"Default route: "+global.defaultRoute)}return n};0&&(module.exports={getApp});
