var u=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var l=Object.prototype.hasOwnProperty;var g=(o,t)=>{for(var e in t)u(o,e,{get:t[e],enumerable:!0})},p=(o,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of f(t))!l.call(o,r)&&r!==e&&u(o,r,{get:()=>t[r],enumerable:!(n=y(t,r))||n.enumerable});return o};var h=o=>p(u({},"__esModule",{value:!0}),o);var x={};g(x,{getAuth:()=>c,handler:()=>d,requireAdmin:()=>S,requireAuth:()=>m,requirePermission:()=>q});module.exports=h(x);var s=require("protobase");var i=require("protobase");var k=(0,s.getLogger)(),c=o=>{let t,e;try{e=JSON.parse(o.cookies.session)}catch{e=null}var n="";let r=o.headers?.authorization;if(r&&r.startsWith("Bearer ")?n=r.slice(7):(o.query.token||e&&e.token)&&(n=o.query.token?o.query.token:e.token,Array.isArray(n)&&(n=n[0])),n)try{t=(0,s.createSession)((0,i.verifyToken)(n))}catch(a){k.error({error:a},"Error reading token"),t=(0,s.createSession)()}else t=(0,s.createSession)();return{session:t,token:n}},d=o=>async(t,e,n)=>{try{let r=c(t);await o(t,e,{...r.session,token:r.token},n)}catch(r){if(r instanceof s.ZodError){let a=r.flatten();e.status(400).send(a)}else r.toString()=="E_PERM"?e.status(403).send({error:r.toString()}):r.toString()=="E_AUTH"?e.status(401).send({error:r.toString()}):r.toString()=="File already exists"?e.status(409).send({error:r.toString()}):e.status(500).send({error:r.toString()})}},m=()=>d(async(o,t,e,n)=>{if(!e||!e.loggedIn){t.status(401).send({error:"Unauthorized"});return}n()}),S=()=>d(async(o,t,e,n)=>{if(!e||!e.user.admin){t.status(401).send({error:"Unauthorized"});return}n()}),q=o=>d(async(t,e,n,r)=>{if(!n||!n.loggedIn){e.status(401).send({error:"Unauthorized"});return}if(!(0,s.checkPermission)(n,o)){e.status(403).send({error:"Forbidden",requiredPermission:o});return}r()});0&&(module.exports={getAuth,handler,requireAdmin,requireAuth,requirePermission});
