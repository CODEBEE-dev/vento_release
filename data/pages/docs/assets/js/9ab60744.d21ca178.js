"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[2030],{1184(e,n,s){s.d(n,{R:()=>o,x:()=>c});var r=s(4041);const i={},t=r.createContext(i);function o(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(t.Provider,{value:n},e.children)}},6235(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"architecture/authentication","title":"Authentication","description":"Vento uses JWT (JSON Web Tokens) for authentication across all services.","source":"@site/docs/architecture/authentication.md","sourceDirName":"architecture","slug":"/architecture/authentication","permalink":"/docs/docs/architecture/authentication","draft":false,"unlisted":false,"editUrl":"https://github.com/protofy-xyz/protofy/tree/main/apps/docs/docs/architecture/authentication.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Architecture","permalink":"/docs/docs/category/architecture"},"next":{"title":"Board Execution","permalink":"/docs/docs/architecture/board-execution"}}');var i=s(1085),t=s(1184);const o={},c="Authentication",d={},a=[{value:"Token Types",id:"token-types",level:2},{value:"Session Structure",id:"session-structure",level:2},{value:"Token Generation",id:"token-generation",level:2},{value:"Service Token",id:"service-token",level:2},{value:"API Handler",id:"api-handler",level:2},{value:"requireAdmin Middleware",id:"requireadmin-middleware",level:3},{value:"Authentication Flow",id:"authentication-flow",level:2},{value:"1. Login",id:"1-login",level:3},{value:"2. Use Token",id:"2-use-token",level:3},{value:"3. Verify",id:"3-verify",level:3},{value:"Password Hashing",id:"password-hashing",level:2},{value:"Common Gotchas",id:"common-gotchas",level:2},{value:"Frontend Session Hook",id:"frontend-session-hook",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"authentication",children:"Authentication"})}),"\n",(0,i.jsx)(n.p,{children:"Vento uses JWT (JSON Web Tokens) for authentication across all services."}),"\n",(0,i.jsx)(n.h2,{id:"token-types",children:"Token Types"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Purpose"}),(0,i.jsx)(n.th,{children:"Created By"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"User Token"})}),(0,i.jsx)(n.td,{children:"Authenticate logged-in users"}),(0,i.jsx)(n.td,{children:"Login flow"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Service Token"})}),(0,i.jsx)(n.td,{children:"Internal service-to-service calls"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"getServiceToken()"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Device Token"})}),(0,i.jsx)(n.td,{children:"Device authentication"}),(0,i.jsx)(n.td,{children:"Device registration"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"session-structure",children:"Session Structure"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"type SessionDataType = {\n    user: {\n        admin: boolean,        // Has admin privileges\n        id: string,            // User ID or 'guest'\n        type: 'user' | 'guest' | 'device' | 'system',\n        permissions: string[]  // Permission list\n    },\n    token: string,             // JWT token\n    loggedIn: boolean          // Is authenticated\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"token-generation",children:"Token Generation"}),"\n",(0,i.jsx)(n.p,{children:"Tokens are generated using JWT:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import jwt from 'jsonwebtoken'\n\n// Generate token (requires TOKEN_SECRET env var)\nconst token = jwt.sign(\n    { id: userId, admin: true, type: 'user' },\n    process.env.TOKEN_SECRET,\n    { expiresIn: '3600000s' }\n)\n\n// Verify token\nconst decoded = jwt.verify(token, process.env.TOKEN_SECRET)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"service-token",children:"Service Token"}),"\n",(0,i.jsxs)(n.p,{children:["For internal API calls, use ",(0,i.jsx)(n.code,{children:"getServiceToken()"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { getServiceToken } from 'protonode'\n\n// System-level token with admin privileges\nconst token = getServiceToken()\n// Returns: jwt.sign({id:'system', type:'system', admin:true}, TOKEN_SECRET)\n\n// Use in API calls\nconst result = await API.get(`/api/core/v1/boards?token=${token}`)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"api-handler",children:"API Handler"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"handler"})," function extracts session from requests:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { handler } from 'protonode'\n\napp.get('/my-endpoint', handler(async (req, res, session, next) => {\n    // session is automatically extracted from:\n    // 1. query param: ?token=...\n    // 2. cookie: session\n\n    if (!session.loggedIn) {\n        res.status(401).send({ error: 'Not authenticated' })\n        return\n    }\n\n    if (!session.user.admin) {\n        res.status(403).send({ error: 'Admin required' })\n        return\n    }\n\n    // Proceed with request\n    res.json({ data: 'success' })\n}))\n"})}),"\n",(0,i.jsx)(n.h3,{id:"requireadmin-middleware",children:"requireAdmin Middleware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { requireAdmin } from 'protonode'\n\n// Protect admin-only routes\napp.get('/admin/settings', requireAdmin(), handler(async (req, res, session) => {\n    // Only admins reach here\n}))\n"})}),"\n",(0,i.jsx)(n.h2,{id:"authentication-flow",children:"Authentication Flow"}),"\n",(0,i.jsx)(n.h3,{id:"1-login",children:"1. Login"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-http",children:'POST /api/core/v1/auth/login\nContent-Type: application/json\n\n{\n  "username": "admin",\n  "password": "password"\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Response:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "token": "eyJhbGciOiJIUzI1NiIs...",\n  "user": { "id": "admin", "admin": true }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"2-use-token",children:"2. Use Token"}),"\n",(0,i.jsx)(n.p,{children:"Include token in subsequent requests:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-http",children:"GET /api/core/v1/boards?token=eyJhbGciOiJIUzI1NiIs...\n"})}),"\n",(0,i.jsx)(n.p,{children:"Or set cookie:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"document.cookie = `session=${JSON.stringify({ token: 'eyJ...' })}`\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-verify",children:"3. Verify"}),"\n",(0,i.jsxs)(n.p,{children:["Token is verified on each request via ",(0,i.jsx)(n.code,{children:"handler()"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"password-hashing",children:"Password Hashing"}),"\n",(0,i.jsx)(n.p,{children:"Passwords are hashed using bcrypt:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import bcrypt from 'bcryptjs'\n\n// Hash password\nconst hash = await bcrypt.hash(password, 10)\n\n// Verify password\nconst match = await bcrypt.compare(password, hash)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"common-gotchas",children:"Common Gotchas"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Missing TOKEN_SECRET"}),": Tokens fail to verify if not set"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Token in query vs cookie"}),": Query param takes precedence"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Guest session"}),": Unauthenticated users get ",(0,i.jsx)(n.code,{children:"{ id: 'guest', type: 'guest' }"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Token expiry"}),": Default is very long (3600000s), consider shorter for production"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"frontend-session-hook",children:"Frontend Session Hook"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import { useSession } from 'protolib/lib/useSession'\n\nfunction MyComponent() {\n    const [session, setSession] = useSession()\n    \n    if (!session.loggedIn) {\n        return <LoginForm />\n    }\n    \n    return <div>Welcome, {session.user.id}!</div>\n}\n"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);