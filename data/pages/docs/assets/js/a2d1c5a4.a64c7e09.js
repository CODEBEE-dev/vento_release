"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[7708],{1184(e,n,t){t.d(n,{R:()=>c,x:()=>o});var r=t(4041);const s={},a=r.createContext(s);function c(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),r.createElement(a.Provider,{value:n},e.children)}},7195(e,n,t){t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"architecture/board-execution","title":"Board Execution","description":"Understanding how boards and cards execute internally.","source":"@site/docs/architecture/board-execution.md","sourceDirName":"architecture","slug":"/architecture/board-execution","permalink":"/docs/docs/architecture/board-execution","draft":false,"unlisted":false,"editUrl":"https://github.com/protofy-xyz/protofy/tree/main/apps/docs/docs/architecture/board-execution.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Authentication","permalink":"/docs/docs/architecture/authentication"},"next":{"title":"Monorepo Structure","permalink":"/docs/docs/architecture/monorepo"}}');var s=t(1085),a=t(1184);const c={},o="Board Execution",i={},d=[{value:"Card Execution",id:"card-execution",level:2},{value:"Execution Context",id:"execution-context",level:2},{value:"<code>context</code>",id:"context",level:3},{value:"<code>states</code>",id:"states",level:3},{value:"<code>board</code>",id:"board",level:3},{value:"<code>params</code>",id:"params",level:3},{value:"Executing Other Cards",id:"executing-other-cards",level:2},{value:"Autopilot",id:"autopilot",level:2},{value:"What Autopilot Does",id:"what-autopilot-does",level:3},{value:"Why Separate?",id:"why-separate",level:3},{value:"Autopilot Rules",id:"autopilot-rules",level:3},{value:"Parameter Resolution",id:"parameter-resolution",level:2},{value:"Type Casting",id:"type-casting",level:3},{value:"Context Functions Only",id:"context-functions-only",level:2},{value:"Logging",id:"logging",level:2},{value:"Return Values",id:"return-values",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"board-execution",children:"Board Execution"})}),"\n",(0,s.jsx)(n.p,{children:"Understanding how boards and cards execute internally."}),"\n",(0,s.jsx)(n.h2,{id:"card-execution",children:"Card Execution"}),"\n",(0,s.jsx)(n.p,{children:"When an action card is triggered (via API, event, or another card), the core service loads and executes the card's JavaScript code directly within its process."}),"\n",(0,s.jsxs)(n.p,{children:["Each card file in ",(0,s.jsx)(n.code,{children:"data/boards/{board}/"})," exports a ",(0,s.jsx)(n.code,{children:"run"})," function that receives the execution context:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const run = async ({ context, states, board, params }) => {\n    // Access other card values\n    const temp = states.boards.my_board.temperature\n    \n    // Use context functions\n    const response = await context.chatgpt.prompt({ message: params.query })\n    \n    // Return becomes the card's value\n    return response\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"execution-context",children:"Execution Context"}),"\n",(0,s.jsx)(n.p,{children:"When a card runs, it receives:"}),"\n",(0,s.jsx)(n.h3,{id:"context",children:(0,s.jsx)(n.code,{children:"context"})}),"\n",(0,s.jsxs)(n.p,{children:["All extension functions (",(0,s.jsx)(n.code,{children:"context.chatgpt"}),", ",(0,s.jsx)(n.code,{children:"context.events"}),", etc.)"]}),"\n",(0,s.jsx)(n.h3,{id:"states",children:(0,s.jsx)(n.code,{children:"states"})}),"\n",(0,s.jsx)(n.p,{children:"All board card values:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"{\n    boards: {\n        my_board: {\n            temperature: 23.5,\n            humidity: 65,\n            pump_status: 'off'\n        }\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"board",children:(0,s.jsx)(n.code,{children:"board"})}),"\n",(0,s.jsx)(n.p,{children:"Board utilities:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"board.id                // Board identifier\nboard.log()             // Prefixed logging\nboard.onChange()        // Subscribe to state changes\nboard.execute_action()  // Run another card\n"})}),"\n",(0,s.jsx)(n.h3,{id:"params",children:(0,s.jsx)(n.code,{children:"params"})}),"\n",(0,s.jsx)(n.p,{children:"Input parameters for action cards."}),"\n",(0,s.jsx)(n.h2,{id:"executing-other-cards",children:"Executing Other Cards"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const result = await board.execute_action({\n    name: 'send_alert',\n    params: { message: 'Temperature too high!' },\n    done: (result) => console.log('Success:', result),\n    error: (err) => console.error('Failed:', err)\n})\n"})}),"\n",(0,s.jsx)(n.h2,{id:"autopilot",children:"Autopilot"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.strong,{children:"Autopilot"})," is a separate process spawned when you click the ",(0,s.jsx)(n.strong,{children:"play button"})," on a board."]}),"\n",(0,s.jsx)(n.h3,{id:"what-autopilot-does",children:"What Autopilot Does"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Monitors board state"}),": Watches for changes in card values"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Executes actions"}),": Triggers action cards when conditions are met"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Schedules timers"}),": Plans future executions based on rules"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"why-separate",children:"Why Separate?"}),"\n",(0,s.jsx)(n.p,{children:"Running autopilot in its own process ensures:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"CPU isolation"}),": A busy autopilot doesn't block other boards or core"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Crash resilience"}),": If an autopilot crashes, core continues running"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Independent lifecycle"}),": Each board's automation runs independently"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"autopilot-rules",children:"Autopilot Rules"}),"\n",(0,s.jsxs)(n.p,{children:["Rules are written in ",(0,s.jsx)(n.strong,{children:"natural language"})," and stored in the board's ",(0,s.jsx)(n.code,{children:"rules"})," state. When the autopilot runs, it sends these rules along with the current state and available actions to an LLM, which generates JavaScript code that implements the rules."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example rules (natural language):"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:'"If temperature is above 30, turn on the cooling"'}),"\n",(0,s.jsx)(n.li,{children:'"Check status every 5 minutes"'}),"\n",(0,s.jsx)(n.li,{children:'"When motion is detected, send an alert"'}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Generated JS (by LLM):"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"function process_state(states) {\n    const urls = []\n    if (states['temperature'] > 30) {\n        urls.push('cooling_on')\n    }\n    if (states['motion_detected'] === true) {\n        urls.push('send_alert?message=Motion+detected')\n    }\n    return urls\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"The generated code is cached and only regenerated when the rules change. Each time the board state changes, the code runs to determine which actions to execute."}),"\n",(0,s.jsx)(n.h2,{id:"parameter-resolution",children:"Parameter Resolution"}),"\n",(0,s.jsx)(n.p,{children:"Parameters can reference board state:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Static value\n{ message: "Hello" }\n\n// Reference to card value\n{ message: "board.current_request" }\n\n// Nested property\n{ message: "board.current_request.text" }\n'})}),"\n",(0,s.jsx)(n.h3,{id:"type-casting",children:"Type Casting"}),"\n",(0,s.jsxs)(n.p,{children:["Parameters are cast based on ",(0,s.jsx)(n.code,{children:"configParams.type"}),":"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Conversion"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"string"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"String(value)"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"number"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Number(value)"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"boolean"})}),(0,s.jsx)(n.td,{children:"`value === 'true'"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"json"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"JSON.parse(value)"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"array"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"JSON.parse(value)"})})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"context-functions-only",children:"Context Functions Only"}),"\n",(0,s.jsxs)(n.p,{children:["Card code uses ",(0,s.jsx)(n.code,{children:"context.*"})," functions for all capabilities:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// AI\nconst response = await context.chatgpt.prompt({ message: 'Hello' })\n\n// Events\nawait context.events.emitEvent('my/event', 'card', 'system', {})\n\n// Keys\nconst key = await context.keys.getKey({ key: 'API_KEY' })\n\n// Files\nconst content = await context.files.read({ path: 'data/myfile.txt' })\n"})}),"\n",(0,s.jsx)(n.h2,{id:"logging",children:"Logging"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"board.log('Processing request')\n// Output: \"Board log [my_board]: Processing request\"\n"})}),"\n",(0,s.jsx)(n.h2,{id:"return-values",children:"Return Values"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Value cards"}),": Return value becomes the card's state"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Action cards"}),": Return value is sent as HTTP response and stored as card value"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Value card - computed temperature\nreturn (states.temp_c * 9/5) + 32\n\n// Action card - operation result\nreturn { success: true, orderId: 'ORD-123' }\n"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}}}]);