"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[1018],{1005(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"architecture/mqtt","title":"MQTT Broker","description":"Vento runs an Aedes MQTT broker for real-time communication between services and devices.","source":"@site/docs/architecture/mqtt.md","sourceDirName":"architecture","slug":"/architecture/mqtt","permalink":"/docs/docs/architecture/mqtt","draft":false,"unlisted":false,"editUrl":"https://github.com/protofy-xyz/protofy/tree/main/apps/docs/docs/architecture/mqtt.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Monorepo Structure","permalink":"/docs/docs/architecture/monorepo"},"next":{"title":"Architecture Overview","permalink":"/docs/docs/architecture/overview"}}');var t=s(1085),c=s(1184);const r={},o="MQTT Broker",l={},d=[{value:"Ports",id:"ports",level:2},{value:"Connecting",id:"connecting",level:2},{value:"Node.js Client",id:"nodejs-client",level:3},{value:"Browser Client",id:"browser-client",level:3},{value:"In Extensions",id:"in-extensions",level:3},{value:"Topic Conventions",id:"topic-conventions",level:2},{value:"Notifications",id:"notifications",level:3},{value:"Events",id:"events",level:3},{value:"Devices",id:"devices",level:3},{value:"Wildcards",id:"wildcards",level:2},{value:"Authentication",id:"authentication",level:2},{value:"Quality of Service (QoS)",id:"quality-of-service-qos",level:2},{value:"Using in Card Code",id:"using-in-card-code",level:2},{value:"Frontend Subscription",id:"frontend-subscription",level:2},{value:"Real-Time Lists",id:"real-time-lists",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Connection Refused",id:"connection-refused",level:3},{value:"Messages Not Received",id:"messages-not-received",level:3},{value:"Memory Issues",id:"memory-issues",level:3}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"mqtt-broker",children:"MQTT Broker"})}),"\n",(0,t.jsx)(n.p,{children:"Vento runs an Aedes MQTT broker for real-time communication between services and devices."}),"\n",(0,t.jsx)(n.h2,{id:"ports",children:"Ports"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Port"}),(0,t.jsx)(n.th,{children:"Protocol"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"1883"})}),(0,t.jsx)(n.td,{children:"TCP"}),(0,t.jsx)(n.td,{children:"Standard MQTT for local agents"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"3003"})}),(0,t.jsx)(n.td,{children:"WebSocket"}),(0,t.jsxs)(n.td,{children:["Browser clients via ",(0,t.jsx)(n.code,{children:"/websocket"})]})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"connecting",children:"Connecting"}),"\n",(0,t.jsx)(n.h3,{id:"nodejs-client",children:"Node.js Client"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { getMQTTClient } from 'protonode'\n\nconst mqtt = getMQTTClient('myservice', getServiceToken())\n\n// Subscribe to topic\nmqtt.subscribe('devices/#')\n\n// Handle messages\nmqtt.on('message', (topic, message) => {\n    const data = JSON.parse(message.toString())\n    console.log(`Received on ${topic}:`, data)\n})\n\n// Publish message\nmqtt.publish('my/topic', JSON.stringify({ hello: 'world' }))\n"})}),"\n",(0,t.jsx)(n.h3,{id:"browser-client",children:"Browser Client"}),"\n",(0,t.jsx)(n.p,{children:"Use the WebSocket endpoint:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"const client = mqtt.connect('ws://localhost:3003/websocket')\n\nclient.on('connect', () => {\n    client.subscribe('notifications/#')\n})\n\nclient.on('message', (topic, message) => {\n    console.log(topic, JSON.parse(message))\n})\n"})}),"\n",(0,t.jsx)(n.h3,{id:"in-extensions",children:"In Extensions"}),"\n",(0,t.jsxs)(n.p,{children:["Extensions receive ",(0,t.jsx)(n.code,{children:"mqtt"})," and ",(0,t.jsx)(n.code,{children:"topicSub"})," via context:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"export default async (app, context) => {\n    const { mqtt, topicSub } = context\n    \n    // Subscribe with helper (handles JSON parsing)\n    topicSub(mqtt, 'devices/#', (message, topic) => {\n        console.log('Device message:', message)\n    })\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"topic-conventions",children:"Topic Conventions"}),"\n",(0,t.jsx)(n.h3,{id:"notifications",children:"Notifications"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"notifications/{model}/{action}/{id}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Examples:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"notifications/boards/create/my_agent"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"notifications/devices/update/sensor1"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"notifications/events/create/devices/online"})}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"events",children:"Events"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"notifications/event/create/{path}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Examples:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"notifications/event/create/devices/esp32/online"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"notifications/event/create/orders/created"})}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"devices",children:"Devices"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"devices/{deviceId}/status\ndevices/{deviceId}/command\nhomeassistant/{type}/{id}/config  (ESPHome discovery)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"wildcards",children:"Wildcards"}),"\n",(0,t.jsx)(n.p,{children:"MQTT supports wildcards:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Pattern"}),(0,t.jsx)(n.th,{children:"Matches"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"devices/#"})}),(0,t.jsxs)(n.td,{children:["All topics under ",(0,t.jsx)(n.code,{children:"devices/"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"devices/+/status"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"devices/{any}/status"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"notifications/event/create/orders/#"})}),(0,t.jsx)(n.td,{children:"All order events"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"authentication",children:"Authentication"}),"\n",(0,t.jsxs)(n.p,{children:["MQTT authentication is ",(0,t.jsx)(n.strong,{children:"disabled by default"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Enable with environment variable:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ENABLE_MQTT_AUTH=true yarn start\n"})}),"\n",(0,t.jsx)(n.p,{children:"When enabled, clients must authenticate with valid JWT token."}),"\n",(0,t.jsx)(n.h2,{id:"quality-of-service-qos",children:"Quality of Service (QoS)"}),"\n",(0,t.jsx)(n.p,{children:"Vento uses QoS 0 (at most once) for most messages. This is suitable for:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Real-time sensor data"}),"\n",(0,t.jsx)(n.li,{children:"UI notifications"}),"\n",(0,t.jsx)(n.li,{children:"Event broadcasts"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"For critical messages, consider implementing application-level acknowledgments."}),"\n",(0,t.jsx)(n.h2,{id:"using-in-card-code",children:"Using in Card Code"}),"\n",(0,t.jsx)(n.p,{children:"Cards don't have direct MQTT access. Use events instead:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"// Emit event (published to MQTT automatically)\nawait context.events.emitEvent(\n    'my/custom/topic',\n    'card',\n    'system',\n    { data: 'value' }\n)\n\n// Subscribe to events\ncontext.events.onEvent(\n    context.mqtt,\n    context,\n    (event) => console.log(event),\n    'my/custom/#'\n)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"frontend-subscription",children:"Frontend Subscription"}),"\n",(0,t.jsxs)(n.p,{children:["Use the ",(0,t.jsx)(n.code,{children:"useSubscription"})," hook:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-tsx",children:"import useSubscription from 'protolib/lib/mqtt/useSubscription'\n\nfunction SensorDisplay() {\n    const sub = useSubscription('devices/sensor1/status')\n    \n    useEffect(() => {\n        if (!sub?.onMessage) return\n        \n        const unsub = sub.onMessage((message) => {\n            console.log('Sensor update:', message)\n        })\n        \n        return () => unsub?.()\n    }, [sub?.onMessage])\n    \n    return <div>Listening...</div>\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"real-time-lists",children:"Real-Time Lists"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"useRemoteStateList"})," subscribes to MQTT for live updates:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-tsx",children:"import { useRemoteStateList } from 'protolib/lib/useRemoteState'\n\nconst [items, setItems] = useRemoteStateList(\n    initialData,\n    fetchFn,\n    'notifications/mymodel/#',  // MQTT topic\n    MyModel,\n    true,  // quickRefresh: patch locally\n    false  // disableNotifications\n)\n"})}),"\n",(0,t.jsx)(n.p,{children:"When MQTT message arrives:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"create"}),": Prepends new item to list"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"update"}),": Updates matching item"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"delete"}),": Removes item from list"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"connection-refused",children:"Connection Refused"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Check port 1883/3003 is not in use"}),"\n",(0,t.jsx)(n.li,{children:"Verify Vento is running"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"messages-not-received",children:"Messages Not Received"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Check topic pattern matches"}),"\n",(0,t.jsx)(n.li,{children:"Verify subscription is active"}),"\n",(0,t.jsx)(n.li,{children:"Check for JSON parse errors"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"memory-issues",children:"Memory Issues"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Large message payloads can cause issues"}),"\n",(0,t.jsx)(n.li,{children:"Consider message size limits"}),"\n",(0,t.jsx)(n.li,{children:"Use debouncing for high-frequency updates"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},1184(e,n,s){s.d(n,{R:()=>r,x:()=>o});var i=s(4041);const t={},c=i.createContext(t);function r(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);