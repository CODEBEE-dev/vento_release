"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2153],{12153:function(e,o,n){n.r(o),n.d(o,{RulesSideMenu:function(){return j}});var r=n(52322),t=n(25184),a=n(14503),s=n(47246),i=n(37288),l=n(70142),d=n(2784),c=n(25538),u=n(79690),p=n(20477),m=n(66431),g=n(60892),y=n(99362),h=n(11793),v=n(13296),f=n(85522),b=n(68346),x=n(96876);let j=e=>{let{leftIcons:o=(0,r.jsx)(r.Fragment,{}),icons:n=(0,r.jsx)(r.Fragment,{}),automationInfo:j,boardRef:A,board:w,actions:C,states:M,resolvedTheme:F,readOnly:I=!1}=e,P=(null==M?void 0:M.boards)?M.boards[w.name]:{},R=(null==C?void 0:C.boards)?C.boards[w.name]:{},[k,E]=(0,d.useState)(null),S=(0,d.useMemo)(()=>(function(e){let o=e=>"{\n"+Object.entries(null!=e?e:{}).map(e=>{let[n,r]=e;return"object"==typeof r&&null!==r?"  ".concat(n,": ").concat(o(r),";"):"  ".concat(n,": any;")}).join("\n")+"\n}";return"declare const states: ".concat(o(e),";")})(P),[P]),N=(0,d.useMemo)(()=>{let e=Object.keys(null!=R?R:{}).map(e=>'"'.concat(e,'"')).join(" | ");return"declare const board: {\n  onChange: (params: { name: string, changed: (value: any) => void, inmediate?: boolean }) => void;\n"+"  execute_action: (params: { name: ".concat(e,", params?: Record<string, any> }) => Promise<any>;\n")+"  id: string;\n  log: (...args: any[]) => void;\n};\n};"},[w.name]),T=(0,d.useMemo)(()=>{let e=(0,u.toSourceFile)(j.code),o=(0,u.getDefinition)(e,'"code"');return o&&p.ArrowFunction.isArrowFunction(o)?o.getBodyText():""},[j.code]),_=(0,d.useRef)(T),$=(0,d.useRef)(T),O=(0,a.Py)(),z=(0,c.tg)("ai.enabled",!1),B=(0,c.tg)("ai.provider",""),D=(0,d.useMemo)(()=>(0,f.qI)(B),[B]),W=(null==D?void 0:D.apiKeyName)||"OPENAI_API_KEY",{hasKey:K,updateKey:L,loading:q}=(0,y.W)(W),{isAIReady:H,aiMode:U}=(0,d.useMemo)(()=>B&&"skip"!==B?(null==D?void 0:D.requiresApiKey)?{isAIReady:K,aiMode:"needs-key"}:{isAIReady:!0,aiMode:"ready"}:{isAIReady:!1,aiMode:"not-configured"},[B,D,K]),V=(0,s.Fg)(),Y=(0,d.useMemo)(()=>(0,r.jsx)(m.AU,{rulesProps:{title:"Board Rules"},onModeChange:e=>E(e),onApplyRules:async e=>{var o,n,r,a;if(I)return;let s=await t.API.post("/api/core/v1/autopilot/getBoardCode",{rules:e,previousRules:A.current.rules,states:P,actions:C.boards?C.boards[w.name]:{},boardName:w.name});if(A.current.rules=e,s.isError||s.error||!(null===(o=s.data)||void 0===o?void 0:o.jsCode))throw Error((null===(n=s.error)||void 0===n?void 0:n.message)||(null===(r=s.data)||void 0===r?void 0:r.message)||(null===(a=s.error)||void 0===a?void 0:a.error)||("string"==typeof s.error?s.error:null)||"Error generating rules. The AI model may have returned an empty response.");try{_.current=s.data.jsCode,$.current=s.data.jsCode,await t.API.post("/api/core/v1/boards/".concat(w.name),A.current);let e=(0,u.toSourceFile)(j.code);(0,u.getDefinition)(e,'"code"').getBody().replaceWithText("{\n"+$.current+"\n}"),await t.API.post("/api/core/v1/boards/".concat(w.name,"/automation"),{code:e.getFullText()}),j.code=e.getFullText(),O.show("Rules applied successfully!")}catch(e){throw console.error(e),Error(e.message)}},disableAIPanels:!z,defaultMode:z?"rules":"code",rules:w.rules,rulesConfig:{enabled:H,disabledView:()=>(0,r.jsx)(h.W,{updateKey:L,loading:q,mode:"not-configured"===U?"not-configured":"needs-key",providerName:null==D?void 0:D.name})},leftIcons:(0,r.jsx)(i.sL,{gap:"$3",pl:"$2",children:o}),icons:(0,r.jsxs)(i.sL,{gap:"$3",children:[n,(0,r.jsx)(i.sL,{p:"$2",pr:"$3",cursor:I?"default":"pointer",onPress:async()=>{if(I)return;let e=(0,u.toSourceFile)(j.code);(0,u.getDefinition)(e,'"code"').getBody().replaceWithText("{\n"+$.current+"\n}"),await t.API.post("/api/core/v1/boards/".concat(w.name,"/automation"),{code:e.getFullText()}),O.show("Automation saved")},o:I?.5:.8,pressStyle:I?void 0:{opacity:.8},ml:"$5",hoverStyle:I?void 0:{opacity:1},children:(0,r.jsx)(g.v,{size:"$1",color:"var(--color)"})})]}),viewPort:{x:20,y:window.innerHeight/8,zoom:.8},onFlowChange:e=>{if(I)return},onCodeChange:e=>{if(I)return},path:w.name+".ts",sourceCode:$,monacoOnMount:(e,o)=>{o.languages.typescript.typescriptDefaults.addExtraLib(N+"\n"+S,"ts:filename/customTypes.d.ts")},monacoOptions:{folding:!0,lineDecorationsWidth:0,lineNumbersMinChars:0,lineNumbers:!0,minimap:{enabled:!1}},readOnly:I}),[F,w.name,V,$.current,z,H,q]);return(0,r.jsxs)(v.eh,{direction:"horizontal",style:{height:"100%"},children:[(0,r.jsx)(v.s_,{defaultSize:70,minSize:20,children:(0,r.jsx)(i.FA,{w:"100%",backgroundColor:"transparent",backdropFilter:"blur(5px)",height:"100%",children:(0,r.jsx)(l.I,{children:(0,r.jsx)(i.FA,{flex:1,alignItems:"center",justifyContent:"center",children:Y})})})}),(0,r.jsx)(b.Z,{direction:"vertical"}),(0,r.jsx)(x.M,{board:w,type:"board",panels:["actions","states"],actions:{[w.name]:R},states:{[w.name]:P},copyMode:k})]})}}}]);